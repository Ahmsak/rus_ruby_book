% CHANGE:
% Больше нет необходимости в явном указании {alltt};

\ProvidesPackage{krugloff}

\clubpenalty=10000 % запрет разрыва после первой строки абзаца.
\widowpenalty=10000 % запрет разрыва перед последней строкой абзаца.
\tolerance=5000

\RequirePackage{xltxtra}
\RequirePackage{xunicode}
\RequirePackage{xecyr}

\RequirePackage{indentfirst}
\RequirePackage{longtable}
\RequirePackage{fontspec}
\RequirePackage{underscore}
\RequirePackage[matrix,arrow,curve]{xy}
\RequirePackage{parallel}
\RequirePackage{alltt}

\RequirePackage{polyglossia}
\setdefaultlanguage{russian}
\setotherlanguage{english}
\setmainfont{Liberation Serif}
\setsansfont{Liberation Sans}
\setmonofont[Scale=0.75]{Liberation Mono}
\defaultfontfeatures{Scale=MatchLowercase,Mapping=tex-text}

% Без этого почему-то не получаются длинные тире.
\newfontfamily\russianfont[Scale=MatchLowercase,Mapping=tex-text]{Liberation Serif}

\RequirePackage{fancyvrb}
\VerbatimFootnotes

\RequirePackage[xetex,
  frenchlinks,
  colorlinks,
  linkcolor=black,
  urlcolor=black,
  bookmarksnumbered]{hyperref}

\newcommand{\italy}[1]{\textit{#1}}
\newcommand{\mono}[1]{\texttt{#1}}

\renewcommand{\epigraph}[2] { %
  \hfill \begin{minipage}[h]{0.75\textwidth} %
    \italy{#1} %
    \begin{flushright} \italy{#2} \end{flushright} %
  \end{minipage} \bigskip} 

% Примечания автора.
\newenvironment{note}
  {\begin{samepage} \bigskip \hrule \nopagebreak \medskip \itshape}
  {\medskip \hrule \bigskip \end{samepage}}

% Заголовок списка.
\newcommand{\itemtitle}[1]{ \bigskip \noindent #1 \smallskip}

% DRY
\newcommand{\keylisttitle}[1]{\hline \italy{#1} \medskip \hrule \smallskip}

% Список определений в рамке.
\newenvironment{keylist}[1]
  {\begin{longtable}[l]{| p{0.97\textwidth} |} %
    \keylisttitle{#1} \endfirsthead \keylisttitle{#1} \endhead \hline \endfoot \hline \endlastfoot }
  { \end{minipage} \\[7pt] \hline \end{longtable}}

% {minipage} используется, чтобы в теле определения был доступен \\.
\newcommand{\firstkey}[1]{ \begin{minipage}[b]{0.97\textwidth} \textbf{#1} }
\newcommand{\key}[1]{\end{minipage} \\[1em] \firstkey{#1}}

\RecustomVerbatimEnvironment
  {verbatim}{Verbatim}
  {gobble=2, frame=leftline, samepage=true}

\newenvironment{operator}
  {\begin{description}}
  {\end{description} \bigskip}

\newcommand{\define}[2]{\item[{#1}] (#2) \\}

\newenvironment{methodlist}
  {\begin{description}}
  {\end{description} \bigskip}

\newcommand{\declare}[2]{\item[{#1}] \italy{#2} \\}

\newcommand{\twoless}{\textless\textless\-,\-,}
\newcommand{\twogreat}{\textgreater\textgreater\-,\-,}
\newcommand{\twominus}{\-/\-/}

% ToDo: Сделать ссылки на методы, константы и ошибки.
\newcommand{\method}[1]{\mono{#1}}
\newcommand{\constant}[1]{\mono{#1}}
\newcommand{\error}[1]{\mono{#1}}
\newcommand{\alias}[1]{Синонимы: \method{#1} \par}